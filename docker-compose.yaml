version: '3.4'

secrets:
    discord_client_token:
        file: ./discord_client_token
    discord_application_id:
        file: ./discord_application_id
    discord_client_secret:
        file: ./discord_client_secret

services:
    simple-discord:
        build:
            context: .
            dockerfile: Dockerfile
            target: PROD
        restart: "unless-stopped"
        container_name: "SimpleDiscord"
        volumes:
            - ./src/:/usr/src/app/src
            - ./demo/:/usr/src/app/demo
        command: python -u demo/run_bot.py
        user: "${UID}:${GID}"
        secrets:
            - discord_client_token
            - discord_application_id
            - discord_client_secret
        environment:
            - PYTHONDONTWRITEBYTECODE=1

    simple-discord-tests:
        build:
            context: .
            dockerfile: Dockerfile
            target: TEST
        restart: "no"
        container_name: "TESTSimpleDiscord"
        volumes:
            - ./:/usr/src/app/
        user: "${UID}:${GID}"
        environment:
            - PYTHONDONTWRITEBYTECODE=1

    documentation:
        build:
            context: .
            dockerfile: Dockerfile
            target: DOCS
        restart: "no"
        volumes:
            - ./:/usr/src/app/
        user: "${UID}:${GID}"
        ports:
        - "8000:8000"
        command: "mkdocs serve -a 0.0.0.0:8000"

    releaser:
        build:
            context: .
            dockerfile: Dockerfile
            target: RELEASE
        restart: "no"
        volumes:
            - ./:/usr/src/app/
        environment:
            - TWINE_USERNAME=${TWINE_TEST_USERNAME}
            - TWINE_PASSWORD=${TWINE_TEST_PASSWORD}
        user: "${UID}:${GID}"
